train_accuracy: 0.7352941176470589
test_accuracy: 0.6956521739130435
optimized ruleset_2:
- Make the smallest, most localized change that addresses the issue; modify the correct layer/entry-point (method/class) where the behavior is defined rather than adding wrappers or unrelated helpers.
- Mirror established patterns and conventions in the codebase (naming, logging style, repr/str formatting, id_for_label semantics, backend-specific overrides like as_sqlite()/as_oracle()) to maintain compatibility with existing tests and style.
- When changing error messages, include required placeholders and pass params so messages render exactly as expected; do not rephrase messages or change punctuation/quoting styles used across the codebase.
- Do not add demonstration scripts, debug files, or extraneous modules; only modify production code and, when appropriate, existing tests relevant to the change.
- Respect immutability and hashing semantics: if implementing __eq__, also implement a consistent __hash__ so that equal objects have equal hashes; avoid identity-based hashing for value-equal objects; for collections of errors, ignore ordering where appropriate and use stable, hashable representations.
- Prefer reusing existing helpers/utilities (e.g., HasKey, get_email_field_name(), deconstruct()) instead of reimplementing logic; when cloning complex objects (like Q), prefer deconstruct()/reconstruct over deepcopy to avoid copying unpickleable objects.
- Normalize non-pickleable, iterator-like values (e.g., dict_keys, dict_values, dict_items) to concrete types (e.g., list/tuple) during deconstruction/serialization paths to ensure pickling and migrations work; when reconstructing iterables from resolved lookup values, preserve the original container type and detect namedtuples via _make/_fields, unpacking with *values.
- For exec/evaluation contexts, provide the appropriate globals() (not an empty dict) to allow access to imports and module globals while executing dynamic code.
- When handling Q/combinator logic, support combining with conditional expressions (objects exposing conditional=True) by accepting and/or wrapping them; when cloning/combining with empty Q, reconstruct from deconstruct() rather than deepcopy.
- For combined query operations, enforce unsupported operations early with clear errors (e.g., distinct() on UNION/INTERSECT/EXCEPT); propagate “empty” state to combined queries and short-circuit execution (e.g., raise EmptyResultSet) when appropriate; ensure .none() on combined queries returns no results.
- For database/backend-specific behavior, use the correct backend hooks and SQL helpers; ensure lookups distinguish between missing keys and explicit JSON nulls, following backend primitives (e.g., JSON_TYPE on SQLite, composite predicates on Oracle).
- When reordering operations (e.g., migrations), prefer adjusting generation order rather than bolting on complex dependencies; ensure operations that depend on synthesized fields (e.g., _order) are generated after AlterOrderWithRespectTo creates them.
- Validate and normalize inputs early (e.g., expand user paths, absolutize, strip trailing path separators before os.path.basename) so downstream logic receives canonical values.
- Ensure subclass/instance checks for metaclasses honor inheritance of known subclasses and their subclasses (e.g., use issubclass against a tuple of supported subclasses) so custom subclasses pass framework checks.
- Keep repr/str outputs aligned with existing formatting (correct quoting and route/url_name formatting); when displaying wrapped callables (e.g., functools.partial), match project expectations for repr while preserving self.func unchanged (e.g., include repr(self.func) in __repr__ but compute view_name from the unwrapped underlying callable).
- Avoid broad behavior changes that alter public APIs or cached behavior beyond the scope of the fix; keep diffs minimal and targeted to the reported issue.
- For widget labeling, return None from id_for_label when the widget renders no labelable element; for subwidgets, prefer IDs supplied via attrs (e.g., ChoiceWidget.options) over reconstructed IDs.
- When extending token/hash generation with additional fields (e.g., email), use model APIs (e.g., get_email_field_name()), handle None safely, and preserve backward compatibility where required (e.g., accept legacy tokens).
- When adding logging around error-swallowing code paths (e.g., send_robust, session decoding fallbacks), use the project’s logger name and format; include exc_info with the actual exception object; don’t modify control flow beyond logging and returning safe defaults (e.g., on BadSignature/base64 errors, fall back to legacy decode and return an empty session if necessary).
- For combined group-by/annotation generation, avoid ambiguous aliases; if an annotation alias collides with joined column names, group by the full expression instead of the alias.
- In ForeignKey assignment, when the related object’s PK is set after assignment, update the FK field when its value is in field.empty_values (not just None) to reflect the related object’s saved primary key.
- In Management/CLI code, ensure parsers are instantiated with the computed program name (prog) rather than relying on sys.argv; preserve consistent help/usage output across environments.
- In admin inline configuration, if verbose_name_plural is unset but verbose_name is provided, derive plural from verbose_name; otherwise fall back to the model’s verbose_name_plural.
- For ordering across relationships, base comparisons on the final path component (e.g., pieces[-1]) and avoid injecting related model default ordering when ordering by pk or an explicit attribute/attname; preserve requested ASC/DESC.
- When validating model default PK configuration, do not warn on child models inheriting a parent_link OneToOneField primary key; only warn on truly auto-created PKs lacking explicit configuration.
- For form/field validation, include the offending value in invalid_choice errors via params (e.g., {'value': value}); for model instances, include a useful scalar (e.g., pk) in the message where applicable.
